import{j as l,E as h,c as p,b as t,q as i,h as r,ah as k,f as a,w as e,I as o,ai as d}from"./chunks/framework.Br27zpCu.js";const x=JSON.parse('{"title":"NextAuth Integration","description":"","frontmatter":{},"headers":[],"relativePath":"bagisto-headless-ecommerce/authentication/nextauth-setup.md","filePath":"bagisto-headless-ecommerce/authentication/nextauth-setup.md","lastUpdated":1768479654000}'),c={name:"bagisto-headless-ecommerce/authentication/nextauth-setup.md"};function E(g,s,u,y,m,A){const n=h("Mermaid");return t(),p("div",null,[s[1]||(s[1]=i("h1",{id:"nextauth-integration",tabindex:"-1"},[a("NextAuth Integration "),i("a",{class:"header-anchor",href:"#nextauth-integration","aria-label":'Permalink to "NextAuth Integration"'},"‚Äã")],-1)),s[2]||(s[2]=i("p",null,[a("This guide explains how authentication is implemented in the Bagisto Headless storefront using "),i("strong",null,"NextAuth.js"),a(". We use a decoupled authentication flow where NextAuth manages the application session while communicating with the Bagisto GraphQL API for credential verification.")],-1)),s[3]||(s[3]=i("h2",{id:"_2-1-implementation-architecture",tabindex:"-1"},[a("2.1 Implementation Architecture "),i("a",{class:"header-anchor",href:"#_2-1-implementation-architecture","aria-label":'Permalink to "2.1 Implementation Architecture"'},"‚Äã")],-1)),(t(),r(d,null,{default:e(()=>[o(n,{id:"mermaid-9",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20User%0A%20%20%20%20participant%20NextJS%20as%20Next.js%20Storefront%0A%20%20%20%20participant%20NextAuth%20as%20NextAuth.js%0A%20%20%20%20participant%20Bagisto%20as%20Bagisto%20GraphQL%20API%0A%0A%20%20%20%20User-%3E%3ENextJS%3A%20Submits%20Login%20Form%0A%20%20%20%20NextJS-%3E%3ENextAuth%3A%20Trigger%20signIn('credentials'%2C%20...)%0A%20%20%20%20NextAuth-%3E%3EBagisto%3A%20Execute%20CUSTOMER_LOGIN%20Mutation%0A%20%20%20%20Bagisto--%3E%3ENextAuth%3A%20Return%20API%20Token%20%26%20Customer%20Data%0A%20%20%20%20NextAuth-%3E%3ENextAuth%3A%20Encrypt%20JWT%20%26%20Create%20Session%0A%20%20%20%20NextAuth--%3E%3ENextJS%3A%20Authentication%20Successful%0A%20%20%20%20NextJS-%3E%3EUser%3A%20Redirect%20to%20Account%2FHome%0A"})]),fallback:e(()=>[...s[0]||(s[0]=[a(" Loading... ",-1)])]),_:1})),s[4]||(s[4]=k(`<h2 id="_2-2-core-files-logic" tabindex="-1">2.2 Core Files &amp; Logic <a class="header-anchor" href="#_2-2-core-files-logic" aria-label="Permalink to &quot;2.2 Core Files &amp; Logic&quot;">‚Äã</a></h2><table tabindex="0"><thead><tr><th style="text-align:left;">File Path</th><th style="text-align:left;">Purpose</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>[<code>utils/auth.ts</code>]</strong></td><td style="text-align:left;">Defines <code>authOptions</code>, including the custom Credentials provider and callbacks.</td></tr><tr><td style="text-align:left;"><strong>[<code>api/auth/[...nextauth]/route.ts</code>]</strong></td><td style="text-align:left;">The NextAuth dynamic API route that handles all auth requests.</td></tr><tr><td style="text-align:left;"><strong>[<code>providers/NextAuthProvider.tsx</code>]</strong></td><td style="text-align:left;">Client-side wrapper that provides session context to the entire application.</td></tr><tr><td style="text-align:left;"><strong>[<code>types/next-auth.d.ts</code>]</strong></td><td style="text-align:left;">TypeScript definitions to extend the User and Session objects with custom fields.</td></tr></tbody></table><h2 id="_2-3-custom-credentials-provider" tabindex="-1">2.3 Custom Credentials Provider <a class="header-anchor" href="#_2-3-custom-credentials-provider" aria-label="Permalink to &quot;2.3 Custom Credentials Provider&quot;">‚Äã</a></h2><p>The storefront uses a custom credentials provider to authenticate customers directly against the Bagisto backend.</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Logic from src/utils/auth.ts</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CredentialsProvider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Credentials&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  authorize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">credentials</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. Fetch from Bagisto</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> bagistoFetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      query: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CUSTOMER_LOGIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      variables: { input: { email, password } },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> login</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> res?.body?.data?.createLogin?.login;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. Validate response</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">login?.success) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(login?.message);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. Return user object to persist in JWT</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      email: credentials.username,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      apiToken: login.apiToken,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      accessToken: login.token, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Sanctum token</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Session Persistence Logic</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">callbacks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  async </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">jwt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ token, user }) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (user) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      token.accessToken </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.accessToken;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      token.apiToken </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.apiToken;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> token;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  async </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">session</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ session, token }) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    session.user.accessToken </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> token.accessToken;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    session.user.apiToken </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> token.apiToken;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="_2-4-token-usage-in-graphql" tabindex="-1">2.4 Token Usage in GraphQL <a class="header-anchor" href="#_2-4-token-usage-in-graphql" aria-label="Permalink to &quot;2.4 Token Usage in GraphQL&quot;">‚Äã</a></h2><p>When making authenticated requests (e.g., adding to cart, viewing orders), the <code>accessToken</code> is retrieved from the NextAuth session and injected into the GraphQL headers via the Apollo Link.</p><p>üìñ <strong>See:</strong> <a href="/bagisto-headless-ecommerce/apollo-client/apollo-setup">Apollo Client Setup</a></p><h2 id="_2-5-security-best-practices" tabindex="-1">2.5 Security Best Practices <a class="header-anchor" href="#_2-5-security-best-practices" aria-label="Permalink to &quot;2.5 Security Best Practices&quot;">‚Äã</a></h2><div class="important custom-block github-alert"><p class="custom-block-title">IMPORTANT</p><p><strong>NEXTAUTH_SECRET:</strong> This environment variable is critical for encrypting the session JWT. Ensure it is a long, random string generated via <code>openssl rand -base64 32</code>.</p></div><ul><li><strong>Client-Side:</strong> Use the <code>useSession()</code> hook to check authentication status.</li><li><strong>Server-Side:</strong> Use <code>getServerSession(authOptions)</code> for secure server-side checks.</li><li><strong>Token Storage:</strong> Authentication tokens are stored in an encrypted HTTP-only cookie by NextAuth for maximum security.</li></ul><h2 id="_2-6-common-workflows" tabindex="-1">2.6 Common Workflows <a class="header-anchor" href="#_2-6-common-workflows" aria-label="Permalink to &quot;2.6 Common Workflows&quot;">‚Äã</a></h2><h3 id="manual-sign-in" tabindex="-1">Manual Sign-In <a class="header-anchor" href="#manual-sign-in" aria-label="Permalink to &quot;Manual Sign-In&quot;">‚Äã</a></h3><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { signIn } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;next-auth/react&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleLogin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> signIn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;credentials&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    username: data.email,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    password: data.password,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    callbackUrl: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/customer/account&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><hr><h3 id="checking-auth-in-middleware" tabindex="-1">Checking Auth in Middleware <a class="header-anchor" href="#checking-auth-in-middleware" aria-label="Permalink to &quot;Checking Auth in Middleware&quot;">‚Äã</a></h3><p>To protect entire routes, use Next.js Middleware in conjunction with NextAuth.</p><p>üèóÔ∏è <strong>Next Steps:</strong></p><ul><li><a href="/bagisto-headless-ecommerce/getting-started/project-setup">Project Setup</a></li><li><a href="/bagisto-headless-ecommerce/apollo-client/apollo-setup">Apollo Client Setup</a></li><li><a href="/bagisto-headless-ecommerce/getting-started/environment-variables">Environment Variables</a></li></ul>`,20))])}const b=l(c,[["render",E]]);export{x as __pageData,b as default};
