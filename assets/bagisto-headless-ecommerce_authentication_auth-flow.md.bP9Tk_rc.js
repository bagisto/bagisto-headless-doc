import{j as h,E as c,c as p,b as i,q as t,h as n,ah as r,f as a,w as s,I as l,ai as d}from"./chunks/framework.Br27zpCu.js";const y=JSON.parse('{"title":"Authentication Flow","description":"","frontmatter":{},"headers":[],"relativePath":"bagisto-headless-ecommerce/authentication/auth-flow.md","filePath":"bagisto-headless-ecommerce/authentication/auth-flow.md","lastUpdated":1768400804000}'),u={name:"bagisto-headless-ecommerce/authentication/auth-flow.md"};function g(m,e,k,f,A,b){const o=c("Mermaid");return i(),p("div",null,[e[2]||(e[2]=t("h1",{id:"authentication-flow",tabindex:"-1"},[a("Authentication Flow "),t("a",{class:"header-anchor",href:"#authentication-flow","aria-label":'Permalink to "Authentication Flow"'},"â€‹")],-1)),e[3]||(e[3]=t("p",null,"This document provides a sequential breakdown of the authentication lifecycle in the Bagisto Headless project. It covers how a user transitions from an anonymous state to an authenticated one and how sessions are maintained across requests.",-1)),e[4]||(e[4]=t("h2",{id:"_3-1-scenario-customer-login-flow",tabindex:"-1"},[a("3.1 Scenario: Customer Login Flow "),t("a",{class:"header-anchor",href:"#_3-1-scenario-customer-login-flow","aria-label":'Permalink to "3.1 Scenario: Customer Login Flow"'},"â€‹")],-1)),e[5]||(e[5]=t("p",null,"The following flow describes the journey from the Login Page to an authenticated Account Dashbaord.",-1)),(i(),n(d,null,{default:s(()=>[l(o,{id:"mermaid-12",class:"mermaid",graph:"graph%20TD%0A%20%20%20%20Start(%5BUser%20on%20%2Fcustomer%2Flogin%5D)%20--%3E%20Input%5BEnters%20Email%20%26%20Password%5D%0A%20%20%20%20Input%20--%3E%20Trigger%5B%22signIn('credentials'%2C%20...%20)%22%5D%0A%20%20%20%20Trigger%20--%3E%20Authorize%7B%7B%22Authorize%20Function%20(utils%2Fauth.ts)%22%7D%7D%0A%20%20%20%20Authorize%20--%3E%20GQL%5B%22Mutation%3A%20CUSTOMER_LOGIN%22%5D%0A%20%20%20%20GQL%20--%3E%20Bagisto(%5B%22Bagisto%20Backend%22%5D)%0A%20%20%20%20Bagisto%20--%20Valid%20Credentials%20--%3E%20Success%5BReturn%20apiToken%20%26%20accessToken%5D%0A%20%20%20%20Success%20--%3E%20Callback%5B%22jwt()%20%26%20session()%20Callbacks%22%5D%0A%20%20%20%20Callback%20--%3E%20Persist%5BEncrypted%20Cookie%20Saved%5D%0A%20%20%20%20Persist%20--%3E%20Redirect(%5BRedirect%20to%20%2Fcustomer%2Faccount%5D)%0A%20%20%20%20%0A%20%20%20%20Bagisto%20--%20Invalid%20Credentials%20--%3E%20Error%5BShow%20Error%20Message%5D%0A%20%20%20%20Error%20--%3E%20Start%0A"})]),fallback:s(()=>[...e[0]||(e[0]=[a(" Loading... ",-1)])]),_:1})),e[6]||(e[6]=r(`<h2 id="_3-2-state-management-persistence" tabindex="-1">3.2 State Management &amp; Persistence <a class="header-anchor" href="#_3-2-state-management-persistence" aria-label="Permalink to &quot;3.2 State Management &amp; Persistence&quot;">â€‹</a></h2><p>Authentication state is handled at multiple levels to ensure a fluid user experience.</p><table tabindex="0"><thead><tr><th style="text-align:left;">Layer</th><th style="text-align:left;">Responsibility</th><th style="text-align:left;">persistence</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>NextAuth.js</strong></td><td style="text-align:left;">Manages the primary session and encrypted JWT.</td><td style="text-align:left;"><strong>HTTP-Only Cookie:</strong> Persists across browser refreshes and tabs.</td></tr><tr><td style="text-align:left;"><strong>Apollo Client</strong></td><td style="text-align:left;">Injects the <code>accessToken</code> from the session into every GraphQL request header.</td><td style="text-align:left;"><strong>In-Memory:</strong> The token is retrieved from the session provider dynamically.</td></tr><tr><td style="text-align:left;"><strong>Redux/Zustand</strong></td><td style="text-align:left;">(Optional) Stores non-sensitive user metadata like <code>firstName</code> or <code>email</code>.</td><td style="text-align:left;"><strong>Client State:</strong> Optimized for instant UI updates (e.g., &quot;Hello, User&quot;).</td></tr></tbody></table><h2 id="_3-3-route-protection-strategies" tabindex="-1">3.3 Route Protection Strategies <a class="header-anchor" href="#_3-3-route-protection-strategies" aria-label="Permalink to &quot;3.3 Route Protection Strategies&quot;">â€‹</a></h2><p>The storefront handles protected routes (like <code>/customer/account</code> or <code>/checkout</code>) using two main methods:</p><h3 id="a-middleware-level-global" tabindex="-1">A. MiddleWare Level (Global) <a class="header-anchor" href="#a-middleware-level-global" aria-label="Permalink to &quot;A. MiddleWare Level (Global)&quot;">â€‹</a></h3><p>Controls access before the page even begins to render.</p><ul><li><strong>Workflow:</strong> Redirects unauthenticated users to <code>/customer/login</code> immediately.</li></ul><h3 id="b-page-level-server-component" tabindex="-1">B. Page Level (Server Component) <a class="header-anchor" href="#b-page-level-server-component" aria-label="Permalink to &quot;B. Page Level (Server Component)&quot;">â€‹</a></h3><p>Check session before fetching dashboard data.</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> session</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getServerSession</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(authOptions);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">session) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">redirect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/customer/login&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h2 id="_3-4-data-flow-token-injection" tabindex="-1">3.4 Data Flow: Token Injection <a class="header-anchor" href="#_3-4-data-flow-token-injection" aria-label="Permalink to &quot;3.4 Data Flow: Token Injection&quot;">â€‹</a></h2><p>Once authenticated, every request sent to the Bagisto backend follows this pattern:</p><ol><li><strong>Retreival:</strong> The <code>ApolloLink</code> fetches the <code>accessToken</code> from the NextAuth session.</li><li><strong>Injection:</strong> Adds the header: <code>Authorization: Bearer &lt;token&gt;</code>.</li><li><strong>Verification:</strong> Bagisto verifies the Sanctum/API token.</li><li><strong>Resolution:</strong> Bagisto returns user-specific data (e.g., personalized cart).</li></ol>`,14)),(i(),n(d,null,{default:s(()=>[l(o,{id:"mermaid-123",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20UI%20as%20React%20Component%0A%20%20%20%20participant%20Link%20as%20Apollo%20Auth%20Link%0A%20%20%20%20participant%20API%20as%20Bagisto%20GraphQL%0A%20%20%20%20%0A%20%20%20%20UI-%3E%3ELink%3A%20useQuery(GET_PROFILE)%0A%20%20%20%20Link-%3E%3ELink%3A%20Get%20token%20from%20Session%0A%20%20%20%20Link-%3E%3EAPI%3A%20POST%20%2Fgraphql%20%7B%20Authorization%3A%20Bearer%20...%20%7D%0A%20%20%20%20API--%3E%3EUI%3A%20Return%20Profile%20Data%0A"})]),fallback:s(()=>[...e[1]||(e[1]=[a(" Loading... ",-1)])]),_:1})),e[7]||(e[7]=r('<h2 id="_3-5-session-termination-logout" tabindex="-1">3.5 Session Termination (Logout) <a class="header-anchor" href="#_3-5-session-termination-logout" aria-label="Permalink to &quot;3.5 Session Termination (Logout)&quot;">â€‹</a></h2><p>When a user logs out:</p><ul><li><code>signOut()</code> is triggered from the frontend.</li><li>NextAuth clears the encrypted session cookie.</li><li>The Apollo Cache is reset to prevent stale data leaks.</li><li>The user is redirected to the Homepage or Login page.</li></ul><p>ðŸ“– <strong>Continue Reading:</strong></p><ul><li><a href="/bagisto-headless-ecommerce/authentication/nextauth-setup">NextAuth Integration</a></li><li><a href="/bagisto-headless-ecommerce/apollo-client/apollo-setup">Apollo Client Setup</a></li><li><a href="/bagisto-headless-ecommerce/getting-started/environment-variables">Environment Variables</a></li></ul>',5))])}const v=h(u,[["render",g]]);export{y as __pageData,v as default};
