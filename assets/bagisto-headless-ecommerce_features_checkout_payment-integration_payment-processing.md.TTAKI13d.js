import{j as e,c as a,b as i,ah as t}from"./chunks/framework.Br27zpCu.js";const k=JSON.parse('{"title":"Payment Processing","description":"","frontmatter":{},"headers":[],"relativePath":"bagisto-headless-ecommerce/features/checkout/payment-integration/payment-processing.md","filePath":"bagisto-headless-ecommerce/features/checkout/payment-integration/payment-processing.md","lastUpdated":1769687094000}'),n={name:"bagisto-headless-ecommerce/features/checkout/payment-integration/payment-processing.md"};function r(h,s,l,o,p,c){return i(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="payment-processing" tabindex="-1">Payment Processing <a class="header-anchor" href="#payment-processing" aria-label="Permalink to &quot;Payment Processing&quot;">‚Äã</a></h1><p>This guide explains the technical flow and logic behind processing payments and finalizing orders in the Bagisto Headless storefront.</p><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">‚Äã</a></h2><p>Payment processing is the final stage of the checkout journey. It involves validating the selected payment method, capturing the order intent, communicating with the Bagisto backend to generate an official order record, and handling the transition to the success state.</p><h2 id="_1-capturing-the-payment-intent" tabindex="-1">1. Capturing the Payment Intent <a class="header-anchor" href="#_1-capturing-the-payment-intent" aria-label="Permalink to &quot;1. Capturing the Payment Intent&quot;">‚Äã</a></h2><p>When a user selects a payment method and clicks &quot;Pay Now&quot;, the storefront captures this choice and sends it to the API.</p><h3 id="mutation-execution" tabindex="-1">Mutation Execution <a class="header-anchor" href="#mutation-execution" aria-label="Permalink to &quot;Mutation Execution&quot;">‚Äã</a></h3><p>The <code>CREATE_CHECKOUT_PAYMENT_METHODS</code> mutation is used to associate the payment method with the cart. This step is critical as it allows the backend to perform final total calculations, including any payment-specific surcharges or discounts.</p><p><strong>File:</strong> <code>src/graphql/checkout/mutations/CreateCheckoutPaymentMethod.ts</code></p><h3 id="frontend-transition" tabindex="-1">Frontend Transition <a class="header-anchor" href="#frontend-transition" aria-label="Permalink to &quot;Frontend Transition&quot;">‚Äã</a></h3><p>Upon success, the storefront navigates the user to the <code>review</code> step. At this point, the backend has all the necessary information (Address, Shipping, and Payment) but the order is not yet &quot;placed&quot;.</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// useCheckout.ts</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Save choosing payment choice</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/checkout?step=review&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="_2-final-order-placement" tabindex="-1">2. Final Order Placement <a class="header-anchor" href="#_2-final-order-placement" aria-label="Permalink to &quot;2. Final Order Placement&quot;">‚Äã</a></h2><p>The actual &quot;processing&quot; happens when the user clicks <strong>&quot;Place Order&quot;</strong> on the review page. This triggers the <code>CREATE_CHECKOUT_ORDER</code> mutation.</p><h3 id="order-generation" tabindex="-1">Order Generation <a class="header-anchor" href="#order-generation" aria-label="Permalink to &quot;Order Generation&quot;">‚Äã</a></h3><p>The backend converts the active cart into a permanent order record.</p><ol><li><strong>Validation:</strong> Checks stock, price changes, and payment eligibility one last time.</li><li><strong>Record Creation:</strong> Generates a unique <code>orderId</code>.</li><li><strong>Session Link:</strong> Associates the order with the customer (if logged in) or the checkout token.</li></ol><h3 id="post-placement-logic" tabindex="-1">Post-Placement Logic <a class="header-anchor" href="#post-placement-logic" aria-label="Permalink to &quot;Post-Placement Logic&quot;">‚Äã</a></h3><p>Once the order is successfully created, the storefront performs several cleanup actions:</p><p><strong>File:</strong> <code>src/utils/hooks/useCheckout.ts</code></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mutateAsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">placeOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useMutation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> responseData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response?.data?.createCheckoutOrder?.checkoutOrder;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (responseData) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 1. Store order ID for the success page</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      setCookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ORDER_ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, responseData.orderId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 2. Clear client-side cart state</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clearCart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 3. Navigate to success page</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h2 id="_3-session-and-token-management" tabindex="-1">3. Session and Token Management <a class="header-anchor" href="#_3-session-and-token-management" aria-label="Permalink to &quot;3. Session and Token Management&quot;">‚Äã</a></h2><p>To ensure security and prevent session reuse:</p><ul><li><strong>Cookie Storage:</strong> The <code>ORDER_ID</code> is stored in a cookie so the <code>/success</code> page can retrieve and display the order details without needing an active cart session.</li><li><strong>Token Invalidation:</strong> The <code>resetGuestToken</code> function is called to delete the cart-specific cookie identifiers.</li></ul><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SavePlaceOrder</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> placeOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ token });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> resetGuestToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Deletes GUEST_CART_TOKEN</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h2 id="_4-handling-redirects-online-payments" tabindex="-1">4. Handling Redirects (Online Payments) <a class="header-anchor" href="#_4-handling-redirects-online-payments" aria-label="Permalink to &quot;4. Handling Redirects (Online Payments)&quot;">‚Äã</a></h2><p>For online gateways (e.g., PayPal, Stripe), the architecture supports redirection to external authorization pages.</p><ul><li><strong>Success URL:</strong> Where the gateway should return the user after payment.</li><li><strong>Failure URL:</strong> Where the gateway should return the user if the payment is declined.</li></ul><p>Currently, the storefront can pass these URLs during the payment selection mutation to ensure the user is returned to the correct state in the headless application.</p><h2 id="summary" tabindex="-1">Summary <a class="header-anchor" href="#summary" aria-label="Permalink to &quot;Summary&quot;">‚Äã</a></h2><ul><li><strong>Staged Submission:</strong> Decouples payment selection from final order placement.</li><li><strong>Transaction Safety:</strong> Performs a final validation check at the moment of order creation.</li><li><strong>State Cleanup:</strong> Ensures the browser session is reset immediately after a successful purchase.</li><li><strong>Order Tracking:</strong> Uses temporary cookies to pass order identifiers to the success page.</li></ul><h2 id="next-steps" tabindex="-1">Next Steps <a class="header-anchor" href="#next-steps" aria-label="Permalink to &quot;Next Steps&quot;">‚Äã</a></h2><ul><li>‚úÖ <a href="/bagisto-headless-ecommerce/features/checkout/payment-integration/order-confirmation">Order Success</a> - What the user sees after payment.</li><li>üõçÔ∏è <a href="/bagisto-headless-ecommerce/features/cart/cart-operations/clear-cart">Clear Cart</a> - Deep dive into the session reset logic.</li><li>üí≥ <a href="/bagisto-headless-ecommerce/features/checkout/payment-integration/payment-methods">Payment Methods</a> - How methods are initially selected.</li></ul>`,33)])])}const g=e(n,[["render",r]]);export{k as __pageData,g as default};
