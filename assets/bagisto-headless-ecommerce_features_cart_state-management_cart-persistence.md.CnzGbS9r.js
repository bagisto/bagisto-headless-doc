import{j as e,c as i,b as a,ah as t}from"./chunks/framework.Br27zpCu.js";const c=JSON.parse('{"title":"Cart Persistence","description":"","frontmatter":{},"headers":[],"relativePath":"bagisto-headless-ecommerce/features/cart/state-management/cart-persistence.md","filePath":"bagisto-headless-ecommerce/features/cart/state-management/cart-persistence.md","lastUpdated":1768400804000}'),n={name:"bagisto-headless-ecommerce/features/cart/state-management/cart-persistence.md"};function r(h,s,o,l,p,d){return a(),i("div",null,[...s[0]||(s[0]=[t(`<h1 id="cart-persistence" tabindex="-1">Cart Persistence <a class="header-anchor" href="#cart-persistence" aria-label="Permalink to &quot;Cart Persistence&quot;">‚Äã</a></h1><p>This guide explains how the shopping cart session and data are persisted in the Bagisto Headless storefront.</p><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">‚Äã</a></h2><p>Cart persistence is crucial for a smooth user experience, ensuring that items added to the cart remain there even if the user refreshes the page or returns to the site later. In Bagisto Headless, this is achieved through a combination of cookie-based session management and Redux state synchronization.</p><h2 id="_1-cookie-based-session-persistence" tabindex="-1">1. Cookie-Based Session Persistence <a class="header-anchor" href="#_1-cookie-based-session-persistence" aria-label="Permalink to &quot;1. Cookie-Based Session Persistence&quot;">‚Äã</a></h2><p>The storefront uses cookies to store a secure, encoded token that identifies the user&#39;s active cart session.</p><h3 id="guest-cart-token" tabindex="-1">Guest Cart Token <a class="header-anchor" href="#guest-cart-token" aria-label="Permalink to &quot;Guest Cart Token&quot;">‚Äã</a></h3><p>When a user adds their first item to the cart (as a guest), a <code>GUEST_CART_TOKEN</code> is generated and stored in the browser&#39;s cookies. This token contains an encoded JWT with the <code>sessionToken</code> and <code>cartId</code>.</p><p><strong>File:</strong> <code>src/utils/hooks/useGuestCartToken.ts</code></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newToken</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> encodeJWT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  sessionToken: cart.sessionToken,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  cartId: cart.id,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  isGuest: cart.isGuest,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Persist token in cookies for session longevity</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setCookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">GUEST_CART_TOKEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, newToken);</span></span></code></pre></div><h3 id="advantages-of-cookie-persistence" tabindex="-1">Advantages of Cookie Persistence <a class="header-anchor" href="#advantages-of-cookie-persistence" aria-label="Permalink to &quot;Advantages of Cookie Persistence&quot;">‚Äã</a></h3><ul><li><strong>Automatic Rehydration:</strong> On page load, the storefront checks for the presence of the <code>GUEST_CART_TOKEN</code>. If found, it decodes the token and uses the <code>sessionToken</code> to fetch the current cart state from the Bagisto API.</li><li><strong>Cross-Tab Support:</strong> Since cookies are shared across browser tabs for the same domain, the cart state remains consistent even if a user has multiple tabs open.</li><li><strong>Expiration Control:</strong> Cookies are set with an expiration period, allowing the cart session to persist for several days (e.g., 7 days).</li></ul><h2 id="_2-token-retrieval-and-usage" tabindex="-1">2. Token Retrieval and Usage <a class="header-anchor" href="#_2-token-retrieval-and-usage" aria-label="Permalink to &quot;2. Token Retrieval and Usage&quot;">‚Äã</a></h2><p>The <code>getCartToken</code> utility is the central point for retrieving the active cart session token, whether for guest or logged-in users.</p><p><strong>File:</strong> <code>src/utils/getCartToken.ts</code></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getCartToken</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> raw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getNativeCookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">GUEST_CART_TOKEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">raw) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> isGuest</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getNativeCookie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">IS_GUEST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;false&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> decoded</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> decodeJWT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;{ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sessionToken</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }&gt;(raw, isGuest);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decoded?.sessionToken </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h2 id="_3-redux-state-rehydration" tabindex="-1">3. Redux State Rehydration <a class="header-anchor" href="#_3-redux-state-rehydration" aria-label="Permalink to &quot;3. Redux State Rehydration&quot;">‚Äã</a></h2><p>While the session token is persisted in cookies, the actual cart contents (items, quantities, totals) are stored in Redux for fast UI access.</p><ul><li>On initial load, components like the <code>Navbar</code> or <code>Cart</code> icon use the persisted token to perform a &quot;get cart&quot; query.</li><li>The result of this query is then dispatched to the Redux store via the <code>addItem</code> action, rehydrating the local state with the latest server-side data.</li></ul><h2 id="_4-persistence-for-logged-in-customers" tabindex="-1">4. Persistence for Logged-In Customers <a class="header-anchor" href="#_4-persistence-for-logged-in-customers" aria-label="Permalink to &quot;4. Persistence for Logged-In Customers&quot;">‚Äã</a></h2><p>For authenticated customers, the persistence is handled differently:</p><ul><li>The cart is associated with the customer&#39;s account in the Bagisto backend.</li><li>Upon login, the guest cart is typically merged with the customer&#39;s existing cart.</li><li>The authentication token (JWT) managed by NextAuth.js serves as the primary identifier for fetching the customer&#39;s cart.</li></ul><h2 id="summary" tabindex="-1">Summary <a class="header-anchor" href="#summary" aria-label="Permalink to &quot;Summary&quot;">‚Äã</a></h2><ul><li><strong>Primary Identifier:</strong> <code>GUEST_CART_TOKEN</code> stored in cookies.</li><li><strong>Session Longevity:</strong> Cookies ensure the cart persists across refreshes and browser restarts.</li><li><strong>Fast UI Rehydration:</strong> Redux state is populated from the server using the persisted token on page load.</li><li><strong>Seamless Merge:</strong> Automatically handles transitions from guest to authenticated cart sessions.</li></ul><h2 id="next-steps" tabindex="-1">Next Steps <a class="header-anchor" href="#next-steps" aria-label="Permalink to &quot;Next Steps&quot;">‚Äã</a></h2><ul><li>üî© <a href="/bagisto-headless-ecommerce/features/cart/state-management/redux-integration">Redux Integration</a> - How the local cart state is managed.</li><li>üîê <a href="/bagisto-headless-ecommerce/authentication/nextauth-setup">Customer Authentication</a> - Understanding how customer sessions are handled.</li></ul>`,26)])])}const g=e(n,[["render",r]]);export{c as __pageData,g as default};
